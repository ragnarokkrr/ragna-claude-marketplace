# ADR-0003: PostgreSQL with Row-Level Security for Multi-Tenancy

## Status
Accepted

## Context
The system must support multi-tenancy with complete data isolation between organizations. We need to choose a data isolation strategy that is secure, performant, and maintainable.

**Options Considered:**
1. **Shared Database, Shared Schema with Row-Level Security (RLS)** - Single database, organization_id in all tables
2. **Shared Database, Separate Schemas** - One PostgreSQL schema per organization
3. **Separate Databases** - Dedicated database per organization
4. **NoSQL Multi-Tenant (MongoDB)** - Document-based with tenant partitioning

**Evaluation Criteria:**
- Data isolation security
- Query performance
- Operational complexity
- Cost at scale
- Developer experience

## Decision
We will use **PostgreSQL with Row-Level Security (RLS) and shared schema**.

Implementation approach:
- Every table includes `organization_id UUID NOT NULL`
- PostgreSQL RLS policies enforce tenant filtering at database level
- Application sets `app.current_organization_id` session variable
- Composite indexes on `(organization_id, <primary_key>)`
- Application-level validation as defense-in-depth

## Consequences

### Positive
- **Strong Security**: Database-enforced isolation; impossible to bypass in application code
- **Cost Efficient**: Single database for all tenants; no provisioning overhead
- **Query Performance**: Indexes optimized for tenant-scoped queries
- **Simplified Operations**: One database to backup, monitor, upgrade
- **ACID Guarantees**: Full transactional consistency

### Negative
- **Shared Resource Contention**: One tenant's heavy query load can impact others (mitigated by connection pooling, query timeouts)
- **Schema Evolution**: All tenants must migrate together
- **Query Overhead**: RLS policies add slight overhead to every query

### Risks & Mitigations
- **Risk**: RLS policy misconfiguration leads to data leakage
  - **Mitigation**: Comprehensive integration tests validating tenant isolation; security audit before launch
- **Risk**: Single large tenant impacts performance for others ("noisy neighbor")
  - **Mitigation**: Query timeouts, connection limits per tenant, monitoring for outlier tenants
- **Risk**: Database becomes scaling bottleneck
  - **Mitigation**: Read replicas for reporting queries, vertical scaling runway with RDS

### Follow-up
- Implement automated tests validating RLS policies for every table
- Set up query performance monitoring per organization
- Document RLS policy patterns for new tables
- Consider read replicas if reporting queries cause contention
